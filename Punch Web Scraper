#!/bin/bash
set -euo pipefail

BASE_URL="https://umbra.nascom.nasa.gov/punch/3/CIM/2025/08/31/"
DOWNLOAD_DIR="/Users/samnasri/Downloads/PUNCH_20250831"

BIN_SCRIPT="/Users/samnasri/Desktop/Heliophysics/Heliophysics-/punch_min_binning.py"

mkdir -p "$DOWNLOAD_DIR"

echo "Fetching file list from server..."
HTML="$(curl -fsSL "$BASE_URL")"

FILES=$(echo "$HTML" | grep -oE 'PUNCH[^"]+\.fits' | sort -u)

NUM_FILES=$(echo "$FILES" | wc -l | tr -d ' ')
echo "Found $NUM_FILES FITS files."
echo

for FILE in $FILES; do
  OUT="$DOWNLOAD_DIR/$FILE"
  if [[ -f "$OUT" ]]; then
    echo "Skipping existing file: $FILE"
  else
    echo "Downloading $FILE ..."
    curl -fsSL -o "$OUT" "$BASE_URL$FILE"
  fi
done

echo
echo "Done downloading. Files saved to:"
echo "  $DOWNLOAD_DIR"
echo

echo "Running Python min-bin processor..."
python3 "$BIN_SCRIPT" "$DOWNLOAD_DIR"/*.fits

echo
echo "All done."
